name: Release

permissions:
  pull-requests: write
  contents: write
on:
  pull_request:
    branches:
      - release/current
      - release/*.*.*
    types: [closed]

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    outputs:
      RELEASED_VERSION: ${{ steps.package-json.outputs.packageVersion }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump version (ex. from "v1.0.0-RC.0" to "v1.0.0")
        run: yarn version --no-git-tag-version --preid=RC --patch

      - name: Retrieve information from package.json
        uses: myrotvorets/info-from-package-json-action@2.0.0
        id: package-json

      - name: Update CHANGELOG.md
        uses: stefanzweifel/changelog-updater-action@v1
        with:
          latest-version: v${{ steps.package-json.outputs.packageVersion }}
          release-notes: ${{ github.event.pull_request.body }}

      - name: 'Git commit, tagging and push (commit message: "Release v1.0.0", tag name: "v1.0.0")'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: ${{ github.event.pull_request.base.ref }}
          commit_message: Release v${{ steps.package-json.outputs.packageVersion }}
          tagging_message: v${{ steps.package-json.outputs.packageVersion }}

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ github.event.pull_request.body }}
          tag_name: v${{ steps.package-json.outputs.packageVersion }}
          target_commitish: ${{ github.head_ref }}

      - name: Delete GitHub draft Releases
        uses: hugo19941994/delete-draft-releases@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-pr-for-next-rc:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.RELEASED_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump version for next RC (ex. from "v1.0.0" to "v1.0.1-RC.0")
        run: yarn version --no-git-tag-version --preid=RC --prepatch

      - name: Retrieve information from package.json
        uses: myrotvorets/info-from-package-json-action@1.2.0
        id: package-json

      - name: Git commit
        uses: github-actions-x/commit@v2.9
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-branch: support/prepare-v${{ steps.package-json.outputs.packageVersion }}
          commit-message: 'Bump version'
          name: GitHub Action

      - name: Create PR
        uses: repo-sync/pull-request@v2
        with:
          source_branch: support/prepare-v${{ steps.package-json.outputs.packageVersion }}
          destination_branch: ${{ github.head_ref }}
          pr_title: Prepare v${{ steps.package-json.outputs.packageVersion }}
          pr_label: flag/exclude-from-changelog,type/prepare-next-version
          pr_body: '[skip ci] An automated PR generated by create-pr-for-next-rc'
          github_token: ${{ secrets.GITHUB_TOKEN }}
